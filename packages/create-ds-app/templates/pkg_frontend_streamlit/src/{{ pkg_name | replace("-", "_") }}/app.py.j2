"""Main Streamlit application."""

import base64
import streamlit as st
import pandas as pd
import plotly.express as px
from pathlib import Path

from {{ pkg_name | replace("-", "_") }}.config import settings
from {{ pkg_name | replace("-", "_") }}.components.sidebar import render_sidebar
from {{ pkg_name | replace("-", "_") }}.utils.data_loader import load_sample_data
from {{ pkg_name | replace("-", "_") }}.utils.branding import load_branding_config

branding = load_branding_config()

# Page configuration
st.set_page_config(
    page_title=branding["name"],
    page_icon="üöÄ",
    layout="wide",
    initial_sidebar_state="expanded",
)

# Apply branding CSS
{% raw %}
def apply_branding_css():
    """Apply branding colors and styles."""
    primary_color = branding.get("primaryColor", "#1B54FF")
    secondary_color = branding.get("secondColor", "#1A1A1A")
    third_color = branding.get("thirdColor", "#FFFFFF")

    css = f"""
    <style>
    .main-header {{
        color: {primary_color};
        text-align: center;
        padding: 1rem 0;
    }}
    .branding-container {{
        background-color: {third_color};
        border: 2px solid {primary_color};
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
    }}
    .stButton > button {{
        background-color: {primary_color};
        color: {third_color};
    }}
    .stButton > button:hover {{
        background-color: {secondary_color};
        color: {third_color};
    }}
    </style>
    """
    st.markdown(css, unsafe_allow_html=True)
{% endraw %}

# Apply branding styles
apply_branding_css()

# Initialize session state
if "data" not in st.session_state:
    st.session_state.data = None
if "counter" not in st.session_state:
    st.session_state.counter = 0


def main():
    """Main application function."""

    # Render sidebar
    filters = render_sidebar()
    # Header with logo
    app_name = branding.get("name", "My App")
    logo_path = branding.get("logo_path", None)
    logo_html = ""
    # Check if logo exists and encode it to Base64
    if logo_path and Path(logo_path).exists():
        with open(logo_path, "rb") as img_file:
            encoded = base64.b64encode(img_file.read()).decode("utf-8")
            logo_html = f"<img src='data:image/png;base64,{encoded}' style='height:40px; vertical-align: middle; margin-right: 10px;'>"

    # Render the header with logo and app name
    st.markdown(
        f"""
        <div style='
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        '>
            {logo_html}
            <span style='font-size: 1.4rem; font-weight: 600;'>{app_name}</span>
        </div>
        """,
        unsafe_allow_html=True
    )
{#    # Main content with branding#}
{#    st.markdown(f'<h1 class="main-header">üöÄ {branding.get("name", "{{ app_title }}")}</h1>', unsafe_allow_html=True)#}
{#    #}
{#    # Add logo if available#}
{#    logo_path = branding.get("logo_path", None)#}
{#    if logo_path.exists():#}
{#        col1, col2, col3 = st.columns([1, 2, 1])#}
{#        with col2:#}
{#            st.image(str(logo_path), width=200)#}
{#    #}
    st.markdown("---")

    # Create tabs
    tab1, tab2, tab3 = st.tabs(["üìä Dashboard", "üìà Analytics", "‚öôÔ∏è Settings"])

    with tab1:
        render_dashboard(filters)

    with tab2:
        render_analytics()

    with tab3:
        render_settings()


def render_dashboard(filters):
    """Render the dashboard tab."""
    col1, col2, col3 = st.columns(3)

    # Metrics
    with col1:
        st.metric(
            label="Total Records",
            value="1,234",
            delta="123 (10%)",
        )

    with col2:
        st.metric(
            label="Active Users",
            value="456",
            delta="-12 (-2.5%)",
            delta_color="inverse",
        )

    with col3:
        st.metric(
            label="Revenue",
            value="$12,345",
            delta="$1,234 (10%)",
        )

    st.markdown("---")

    # Sample chart
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üìä Sample Line Chart")
        df = load_sample_data()
        fig = px.line(df, x="date", y="value", title="Time Series Data")
        st.plotly_chart(fig, use_container_width=True)

    with col2:
        st.subheader("üìà Sample Bar Chart")
        df_bar = pd.DataFrame({
            "category": ["A", "B", "C", "D"],
            "values": [23, 45, 56, 78]
        })
        fig = px.bar(df_bar, x="category", y="values", title="Category Distribution")
        st.plotly_chart(fig, use_container_width=True)

    # Data table
    st.subheader("üìã Data Table")
    if st.checkbox("Show raw data"):
        st.dataframe(df, use_container_width=True)


def render_analytics():
    """Render the analytics tab."""
    st.header("üìà Analytics")

    # File uploader
    uploaded_file = st.file_uploader(
        "Choose a CSV file",
        type=["csv"],
        help="Upload a CSV file for analysis"
    )

    if uploaded_file is not None:
        df = pd.read_csv(uploaded_file)
        st.success(f"Loaded {len(df)} rows and {len(df.columns)} columns")

        # Display basic statistics
        st.subheader("Data Overview")
        st.write(df.describe())

        # Column selector for visualization
        numeric_cols = df.select_dtypes(include=["float64", "int64"]).columns.tolist()
        if numeric_cols:
            selected_col = st.selectbox("Select column to visualize", numeric_cols)

            col1, col2 = st.columns(2)
            with col1:
                fig = px.histogram(df, x=selected_col, title=f"Distribution of {selected_col}")
                st.plotly_chart(fig, use_container_width=True)

            with col2:
                fig = px.box(df, y=selected_col, title=f"Box Plot of {selected_col}")
                st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("Upload a CSV file to start analyzing")


def render_settings():
    """Render the settings tab."""
    st.header("‚öôÔ∏è Settings")

    # Configuration form
    with st.form("settings_form"):
        st.subheader("Application Settings")

        col1, col2 = st.columns(2)

        with col1:
            api_url = st.text_input("API URL", value=settings.api_url)
            refresh_rate = st.number_input("Refresh Rate (seconds)", min_value=1, value=60)
            theme = st.selectbox("Theme", ["Light", "Dark", "Auto"])

        with col2:
            debug_mode = st.checkbox("Debug Mode", value=settings.debug_mode)
            cache_enabled = st.checkbox("Enable Cache", value=True)
            notifications = st.checkbox("Enable Notifications", value=True)

        submitted = st.form_submit_button("Save Settings")
        if submitted:
            st.success("Settings saved successfully!")

    # Session state viewer
    st.subheader("Session State")
    if st.checkbox("Show session state"):
        st.json(dict(st.session_state))

    # Counter example
    st.subheader("Interactive Counter")
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("Increment"):
            st.session_state.counter += 1
    with col2:
        if st.button("Decrement"):
            st.session_state.counter -= 1
    with col3:
        if st.button("Reset"):
            st.session_state.counter = 0

    st.info(f"Counter value: {st.session_state.counter}")


if __name__ == "__main__":
    main()